package codegen

import (
	"bytes"
	"fmt"
	"go/format"
)

// GenerateMigrateRunner generates the runner.go file for the migrate subpackage.
func GenerateMigrateRunner(modulePath string) ([]byte, error) {
	var buf bytes.Buffer

	buf.WriteString(`// Code generated by shipq. DO NOT EDIT.
package migrate

import (
	"context"
	"database/sql"
	_ "embed"

	"github.com/shipq/shipq/db/portsql/migrate"
	db "`)
	buf.WriteString(modulePath)
	buf.WriteString(`/shipq/db"
)

//go:embed schema.json
var schemaJSON []byte

// Plan returns the migration plan reconstructed from the embedded schema.
func Plan() (*migrate.MigrationPlan, error) {
	return migrate.PlanFromJSON(schemaJSON)
}

// Run executes all pending migrations against the default database.
// Safe to call on every app startup - only runs unapplied migrations.
func Run(ctx context.Context) error {
	dbConn, err := db.DB()
	if err != nil {
		return err
	}
	return RunWithDB(ctx, dbConn)
}

// RunWithDB executes all pending migrations against the provided database.
// This is useful for running migrations against the test database.
func RunWithDB(ctx context.Context, dbConn *sql.DB) error {
	plan, err := Plan()
	if err != nil {
		return err
	}
	return migrate.Run(ctx, dbConn, plan, db.Dialect)
}
`)

	formatted, err := format.Source(buf.Bytes())
	if err != nil {
		return buf.Bytes(), fmt.Errorf("failed to format runner.go: %w", err)
	}

	return formatted, nil
}
