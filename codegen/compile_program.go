package codegen

import (
	"bytes"
	"fmt"
	"go/format"
	"sort"
)

// CompileProgramConfig holds configuration for generating the compile program.
type CompileProgramConfig struct {
	ModulePath    string   // e.g., "myapp"
	QuerydefsPkgs []string // import paths to querydefs packages
}

// GenerateCompileProgram generates the temporary program that extracts query definitions.
// The generated program imports all querydefs packages (triggering their init() functions),
// then serializes all registered queries to JSON on stdout.
func GenerateCompileProgram(cfg CompileProgramConfig) ([]byte, error) {
	var buf bytes.Buffer

	// Sort for deterministic output
	pkgs := make([]string, len(cfg.QuerydefsPkgs))
	copy(pkgs, cfg.QuerydefsPkgs)
	sort.Strings(pkgs)

	buf.WriteString(`// Code generated by shipq. This file can be run manually for debugging.
//
// To run manually:
//   cd <project_root>
//   go run .shipq/compile/main.go
//
// Output: JSON array of query definitions to stdout
// Errors: Written to stderr
//
package main

import (
	"bytes"
	"encoding/json"
	"fmt"
	"os"

	"github.com/shipq/shipq/db/portsql/query"
`)

	// Write blank imports for querydefs packages
	if len(pkgs) > 0 {
		buf.WriteString("\n\t// Querydefs packages - importing triggers init() registration\n")
		for _, pkg := range pkgs {
			fmt.Fprintf(&buf, "\t_ %q\n", pkg)
		}
	}

	buf.WriteString(`)

func main() {
	// After all init() functions have run, the query registry is populated
	data, err := query.SerializeQueries()
	if err != nil {
		fmt.Fprintf(os.Stderr, "error serializing queries: %v\n", err)
		os.Exit(1)
	}

	// Pretty-print for debuggability
	var pretty bytes.Buffer
	if err := json.Indent(&pretty, data, "", "  "); err != nil {
		fmt.Fprintf(os.Stderr, "error formatting JSON: %v\n", err)
		os.Exit(1)
	}

	os.Stdout.Write(pretty.Bytes())
}
`)

	formatted, err := format.Source(buf.Bytes())
	if err != nil {
		// Return unformatted source for debugging
		return buf.Bytes(), fmt.Errorf("failed to format compile program: %w", err)
	}

	return formatted, nil
}
