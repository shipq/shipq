package config

import (
	"go/parser"
	"go/token"
	"strings"
	"testing"
)

func TestGenerateConfig_ValidGo(t *testing.T) {
	cfg := ConfigGenConfig{
		ModulePath: "example.com/myapp",
	}

	code, err := GenerateConfig(cfg)
	if err != nil {
		t.Fatalf("GenerateConfig() error = %v", err)
	}

	// Verify it's valid Go
	_, err = parser.ParseFile(token.NewFileSet(), "", code, parser.AllErrors)
	if err != nil {
		t.Errorf("generated code is not valid Go: %v\n%s", err, string(code))
	}
}

func TestGenerateConfig_ContainsExpectedElements(t *testing.T) {
	cfg := ConfigGenConfig{
		ModulePath: "example.com/myapp",
	}

	code, err := GenerateConfig(cfg)
	if err != nil {
		t.Fatalf("GenerateConfig() error = %v", err)
	}

	codeStr := string(code)

	// Should have package config
	if !strings.Contains(codeStr, "package config") {
		t.Error("missing package config")
	}

	// Should have SettingsConfig struct
	if !strings.Contains(codeStr, "type SettingsConfig struct") {
		t.Error("missing SettingsConfig struct")
	}

	// Should have DATABASE_URL field
	if !strings.Contains(codeStr, "DATABASE_URL") {
		t.Error("missing DATABASE_URL field")
	}

	// Should have PORT field
	if !strings.Contains(codeStr, "PORT") {
		t.Error("missing PORT field")
	}

	// Should have GO_ENV field
	if !strings.Contains(codeStr, "GO_ENV") {
		t.Error("missing GO_ENV field")
	}

	// Should have COOKIE_SECRET field
	if !strings.Contains(codeStr, "COOKIE_SECRET") {
		t.Error("missing COOKIE_SECRET field")
	}

	// Should have Settings global var
	if !strings.Contains(codeStr, "var Settings SettingsConfig") {
		t.Error("missing Settings global var")
	}

	// Should have Logger global var
	if !strings.Contains(codeStr, "var Logger *slog.Logger") {
		t.Error("missing Logger global var")
	}

	// Should have getLogger function
	if !strings.Contains(codeStr, "func getLogger(env string) *slog.Logger") {
		t.Error("missing getLogger function")
	}

	// Should check for development environment
	if !strings.Contains(codeStr, `env == "development"`) {
		t.Error("missing development environment check")
	}

	// Should import logging package
	if !strings.Contains(codeStr, `"github.com/shipq/shipq/logging"`) {
		t.Error("missing logging package import")
	}

	// Should have init function
	if !strings.Contains(codeStr, "func init()") {
		t.Error("missing init function")
	}

	// Should have Make method
	if !strings.Contains(codeStr, "func (s *SettingsConfig) Make()") {
		t.Error("missing Make method")
	}

	// Should have mustExist function
	if !strings.Contains(codeStr, "func mustExist(name string) string") {
		t.Error("missing mustExist function")
	}
}

func TestGenerateConfig_GeneratedComment(t *testing.T) {
	cfg := ConfigGenConfig{
		ModulePath: "example.com/myapp",
	}

	code, err := GenerateConfig(cfg)
	if err != nil {
		t.Fatalf("GenerateConfig() error = %v", err)
	}

	codeStr := string(code)

	// Should have "Code generated by shipq" comment
	if !strings.Contains(codeStr, "Code generated by shipq") {
		t.Error("missing generated code comment")
	}
}

func TestGenerateConfigTest_ValidGo(t *testing.T) {
	cfg := ConfigGenConfig{
		ModulePath: "example.com/myapp",
	}

	code, err := GenerateConfigTest(cfg)
	if err != nil {
		t.Fatalf("GenerateConfigTest() error = %v", err)
	}

	// Verify it's valid Go
	_, err = parser.ParseFile(token.NewFileSet(), "", code, parser.AllErrors)
	if err != nil {
		t.Errorf("generated code is not valid Go: %v\n%s", err, string(code))
	}
}

func TestGenerateConfigTest_ContainsExpectedElements(t *testing.T) {
	cfg := ConfigGenConfig{
		ModulePath: "example.com/myapp",
	}

	code, err := GenerateConfigTest(cfg)
	if err != nil {
		t.Fatalf("GenerateConfigTest() error = %v", err)
	}

	codeStr := string(code)

	// Should have package config
	if !strings.Contains(codeStr, "package config") {
		t.Error("missing package config")
	}

	// Should have TestProdLogger
	if !strings.Contains(codeStr, "func TestProdLogger(t *testing.T)") {
		t.Error("missing TestProdLogger function")
	}

	// Should have TestDevLogger
	if !strings.Contains(codeStr, "func TestDevLogger(t *testing.T)") {
		t.Error("missing TestDevLogger function")
	}

	// Should import testing
	if !strings.Contains(codeStr, `"testing"`) {
		t.Error("missing testing import")
	}

	// Should import logging
	if !strings.Contains(codeStr, `"github.com/shipq/shipq/logging"`) {
		t.Error("missing logging import")
	}
}
