package config

import (
	"bytes"
	"fmt"
	"go/format"
)

// ConfigGenConfig holds configuration for generating the config package.
type ConfigGenConfig struct {
	ModulePath string // e.g., "myapp" - the user's module path
}

// GenerateConfig generates the config/config.go file.
func GenerateConfig(cfg ConfigGenConfig) ([]byte, error) {
	var buf bytes.Buffer

	buf.WriteString("// Code generated by shipq. DO NOT EDIT.\n")
	buf.WriteString("package config\n\n")

	// Generate imports
	generateConfigImports(&buf, cfg)

	// Generate mustExist helper
	generateMustExist(&buf)

	// Generate SettingsConfig struct
	generateSettingsConfig(&buf)

	// Generate global vars
	generateGlobalVars(&buf)

	// Generate getLogger function
	generateGetLogger(&buf)

	// Generate init function
	generateInit(&buf)

	formatted, err := format.Source(buf.Bytes())
	if err != nil {
		// Return unformatted source for debugging
		return buf.Bytes(), fmt.Errorf("failed to format config.go: %w\nunformatted:\n%s", err, buf.String())
	}

	return formatted, nil
}

// generateConfigImports writes the import block for config.go.
func generateConfigImports(buf *bytes.Buffer, cfg ConfigGenConfig) {
	buf.WriteString("import (\n")
	buf.WriteString("\t\"log\"\n")
	buf.WriteString("\t\"log/slog\"\n")
	buf.WriteString("\t\"os\"\n")
	buf.WriteString("\t\"reflect\"\n")
	buf.WriteString("\n")
	buf.WriteString("\t\"github.com/shipq/shipq/logging\"\n")
	buf.WriteString(")\n\n")
}

// generateMustExist writes the mustExist helper function.
func generateMustExist(buf *bytes.Buffer) {
	buf.WriteString(`func mustExist(name string) string {
	envVar := os.Getenv(name)
	if envVar == "" {
		log.Fatalf("Environment variable %s is not set\n", name)
	}
	return envVar
}

`)
}

// generateSettingsConfig writes the SettingsConfig struct and Make method.
func generateSettingsConfig(buf *bytes.Buffer) {
	buf.WriteString(`// SettingsConfig contains a set of environment variables used to configure the
// API.
type SettingsConfig struct {
	DATABASE_URL string
	PORT         string
	GO_ENV       string
}

// Make populates the SettingsConfig struct with the values from the environment.
// If any of the values are missing, the program will abort.
func (s *SettingsConfig) Make() {
	val := reflect.ValueOf(s).Elem()
	for i := range val.NumField() {
		name := val.Type().Field(i).Name
		envVar := mustExist(name)
		val.Field(i).SetString(envVar)
	}
}

`)
}

// generateGlobalVars writes the global Settings and Logger variables.
func generateGlobalVars(buf *bytes.Buffer) {
	buf.WriteString(`// Settings contains the actual values for the environment variables.
var Settings SettingsConfig

// Logger contains the logger for the application.
var Logger *slog.Logger

`)
}

// generateGetLogger writes the getLogger function.
func generateGetLogger(buf *bytes.Buffer) {
	buf.WriteString(`// getLogger returns the appropriate logger based on the environment.
func getLogger(env string) *slog.Logger {
	if env == "development" {
		return logging.DevLogger
	}
	return logging.ProdLogger
}

`)
}

// generateInit writes the init function.
func generateInit(buf *bytes.Buffer) {
	buf.WriteString(`func init() {
	Settings.Make()
	Logger = getLogger(Settings.GO_ENV)
}
`)
}
