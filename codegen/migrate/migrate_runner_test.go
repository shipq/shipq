package migrate_test

import (
	"strings"
	"testing"

	"github.com/shipq/shipq/codegen/migrate"
)

func TestGenerateMigrateRunner(t *testing.T) {
	t.Run("generates valid go code", func(t *testing.T) {
		modulePath := "example.com/myapp"

		content, err := migrate.GenerateMigrateRunner(modulePath)
		if err != nil {
			t.Fatalf("GenerateMigrateRunner() error = %v", err)
		}

		contentStr := string(content)

		// Check package declaration
		if !strings.Contains(contentStr, "package migrate") {
			t.Error("generated code missing 'package migrate'")
		}

		// Check for generated code header
		if !strings.Contains(contentStr, "Code generated by shipq") {
			t.Error("generated code missing generation header")
		}

		// Check embed directive
		if !strings.Contains(contentStr, "//go:embed schema.json") {
			t.Error("generated code missing embed directive")
		}

		// Check schemaJSON variable
		if !strings.Contains(contentStr, "var schemaJSON []byte") {
			t.Error("generated code missing schemaJSON variable")
		}

		// Check Plan function
		if !strings.Contains(contentStr, "func Plan() (*migrate.MigrationPlan, error)") {
			t.Error("generated code missing Plan() function")
		}

		// Check Run function
		if !strings.Contains(contentStr, "func Run(ctx context.Context) error") {
			t.Error("generated code missing Run() function")
		}

		// Check RunWithDB function
		if !strings.Contains(contentStr, "func RunWithDB(ctx context.Context, dbConn *sql.DB) error") {
			t.Error("generated code missing RunWithDB() function")
		}

		// Check imports
		if !strings.Contains(contentStr, `"context"`) {
			t.Error("generated code missing context import")
		}
		if !strings.Contains(contentStr, `"database/sql"`) {
			t.Error("generated code missing database/sql import")
		}
		if !strings.Contains(contentStr, `_ "embed"`) {
			t.Error("generated code missing embed import")
		}
		if !strings.Contains(contentStr, `"github.com/shipq/shipq/db/portsql/migrate"`) {
			t.Error("generated code missing migrate package import")
		}
	})

	t.Run("includes correct module path import", func(t *testing.T) {
		modulePath := "github.com/user/myproject"

		content, err := migrate.GenerateMigrateRunner(modulePath)
		if err != nil {
			t.Fatalf("GenerateMigrateRunner() error = %v", err)
		}

		contentStr := string(content)

		// Check that the db package import uses the correct module path
		expectedImport := `db "github.com/user/myproject/shipq/db"`
		if !strings.Contains(contentStr, expectedImport) {
			t.Errorf("generated code missing correct db import, want %q", expectedImport)
		}
	})

	t.Run("handles different module paths", func(t *testing.T) {
		testCases := []struct {
			name       string
			modulePath string
			wantImport string
		}{
			{
				name:       "simple module",
				modulePath: "myapp",
				wantImport: `db "myapp/shipq/db"`,
			},
			{
				name:       "github module",
				modulePath: "github.com/user/repo",
				wantImport: `db "github.com/user/repo/shipq/db"`,
			},
			{
				name:       "nested module",
				modulePath: "example.com/org/team/project",
				wantImport: `db "example.com/org/team/project/shipq/db"`,
			},
		}

		for _, tc := range testCases {
			t.Run(tc.name, func(t *testing.T) {
				content, err := migrate.GenerateMigrateRunner(tc.modulePath)
				if err != nil {
					t.Fatalf("GenerateMigrateRunner() error = %v", err)
				}

				contentStr := string(content)

				if !strings.Contains(contentStr, tc.wantImport) {
					t.Errorf("generated code missing import %q", tc.wantImport)
				}
			})
		}
	})

	t.Run("uses db.Dialect constant", func(t *testing.T) {
		content, err := migrate.GenerateMigrateRunner("example.com/myapp")
		if err != nil {
			t.Fatalf("GenerateMigrateRunner() error = %v", err)
		}

		contentStr := string(content)

		// The RunWithDB function should use db.Dialect
		if !strings.Contains(contentStr, "db.Dialect") {
			t.Error("generated code should reference db.Dialect")
		}
	})

	t.Run("calls db.DB() in Run function", func(t *testing.T) {
		content, err := migrate.GenerateMigrateRunner("example.com/myapp")
		if err != nil {
			t.Fatalf("GenerateMigrateRunner() error = %v", err)
		}

		contentStr := string(content)

		if !strings.Contains(contentStr, "db.DB()") {
			t.Error("generated code should call db.DB()")
		}
	})

	t.Run("calls migrate.PlanFromJSON", func(t *testing.T) {
		content, err := migrate.GenerateMigrateRunner("example.com/myapp")
		if err != nil {
			t.Fatalf("GenerateMigrateRunner() error = %v", err)
		}

		contentStr := string(content)

		if !strings.Contains(contentStr, "migrate.PlanFromJSON(schemaJSON)") {
			t.Error("generated code should call migrate.PlanFromJSON with schemaJSON")
		}
	})

	t.Run("calls migrate.Run in RunWithDB", func(t *testing.T) {
		content, err := migrate.GenerateMigrateRunner("example.com/myapp")
		if err != nil {
			t.Fatalf("GenerateMigrateRunner() error = %v", err)
		}

		contentStr := string(content)

		if !strings.Contains(contentStr, "migrate.Run(ctx, dbConn, plan, db.Dialect)") {
			t.Error("generated code should call migrate.Run with correct arguments")
		}
	})
}
