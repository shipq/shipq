// Code generated by portapi testclient generator. DO NOT EDIT.
// This file is test-only and will not be included in production builds.

package gen

import (
	"context"
	"github.com/shipq/shipq/api/portapi"
	"github.com/shipq/shipq/api/portapi/testdata/exampleapi"
	"io"
	"net/http"
	"net/url"
)

// Client is a test client for making HTTP requests to the API.
type Client struct {
	// BaseURL is the base URL for API requests (e.g., "http://localhost:8080").
	BaseURL string

	// HTTP is the HTTP client to use. If nil, http.DefaultClient is used.
	HTTP *http.Client
}

// NewClient creates a new test client with the given base URL.
func NewClient(baseURL string) *Client {
	return &Client{
		BaseURL: baseURL,
		HTTP:    http.DefaultClient,
	}
}

// httpClient returns the HTTP client to use, defaulting to http.DefaultClient.
func (c *Client) httpClient() *http.Client {
	if c.HTTP != nil {
		return c.HTTP
	}
	return http.DefaultClient
}

// do executes an HTTP request and handles the response.
// For 2xx responses, it decodes the body into out (if out is not nil).
// For non-2xx responses, it returns a portapi.HTTPError (satisfying portapi.CodedError).
func (c *Client) do(ctx context.Context, method, path string, query url.Values, headers http.Header, body io.Reader, out any) error {
	// Build URL
	u := c.BaseURL + path
	if len(query) > 0 {
		u += "?" + query.Encode()
	}

	// Create request
	req, err := http.NewRequestWithContext(ctx, method, u, body)
	if err != nil {
		return err
	}

	// Set headers
	req.Header.Set("Accept", "application/json")
	if body != nil {
		req.Header.Set("Content-Type", "application/json")
	}
	for k, vs := range headers {
		for _, v := range vs {
			req.Header.Add(k, v)
		}
	}

	// Execute
	resp, err := c.httpClient().Do(req)
	if err != nil {
		return err
	}
	defer resp.Body.Close()

	// Read body
	respBody, err := io.ReadAll(resp.Body)
	if err != nil {
		return err
	}

	// Handle non-2xx
	if resp.StatusCode < 200 || resp.StatusCode >= 300 {
		return portapi.DecodeErrorEnvelope(resp.StatusCode, resp.Header, respBody)
	}

	// Decode success response
	if out != nil && len(respBody) > 0 {
		if err := portapi.DecodeJSONInto(respBody, out); err != nil {
			return err
		}
	}

	return nil
}

// DeletePet calls DELETE /pets/{id}
func (c *Client) DeletePet(ctx context.Context, req exampleapi.DeletePetReq) error {

	// Build path
	pathVars := map[string]string{
		"id": req.ID,
	}
	path, pathErr := portapi.InterpolatePath("/pets/{id}", pathVars)
	if pathErr != nil {
		return pathErr
	}

	// Build query
	query := url.Values{}

	// Build headers
	headers := make(http.Header)

	// Build body
	var bodyReader io.Reader

	// Execute request
	doErr := c.do(ctx, "DELETE", path, query, headers, bodyReader, nil)
	return doErr
}

// HealthCheck calls GET /health
func (c *Client) HealthCheck(ctx context.Context) error {

	path := "/health"
	query := url.Values{}
	headers := make(http.Header)
	var bodyReader io.Reader

	// Execute request
	err := c.do(ctx, "GET", path, query, headers, bodyReader, nil)
	return err
}

// ListPets calls GET /pets
func (c *Client) ListPets(ctx context.Context) (exampleapi.ListPetsResp, error) {
	var out exampleapi.ListPetsResp

	path := "/pets"
	query := url.Values{}
	headers := make(http.Header)
	var bodyReader io.Reader

	// Execute request
	err := c.do(ctx, "GET", path, query, headers, bodyReader, &out)
	return out, err
}

// SearchPets calls GET /pets/search
func (c *Client) SearchPets(ctx context.Context, req exampleapi.SearchPetsReq) (exampleapi.SearchPetsResp, error) {
	var out exampleapi.SearchPetsResp

	// Build path
	path := "/pets/search"

	// Build query
	query := url.Values{}
	portapi.AddQuery(query, "limit", portapi.FormatInt(req.Limit))

	for _, v := range req.Tags {
		portapi.AddQuery(query, "tag", v)
	}

	if req.Cursor != nil {
		portapi.AddQuery(query, "cursor", *req.Cursor)
	}

	// Build headers
	headers := make(http.Header)
	if req.Auth != nil {
		headers.Set("Authorization", *req.Auth)
	}

	// Build body
	var bodyReader io.Reader

	// Execute request
	doErr := c.do(ctx, "GET", path, query, headers, bodyReader, &out)
	return out, doErr
}

// GetPet calls GET /pets/{id}
func (c *Client) GetPet(ctx context.Context, req exampleapi.GetPetReq) (exampleapi.GetPetResp, error) {
	var out exampleapi.GetPetResp

	// Build path
	pathVars := map[string]string{
		"id": req.ID,
	}
	path, pathErr := portapi.InterpolatePath("/pets/{id}", pathVars)
	if pathErr != nil {
		return out, pathErr
	}

	// Build query
	query := url.Values{}
	if req.Verbose != nil {
		portapi.AddQuery(query, "verbose", portapi.FormatBool(*req.Verbose))
	}

	// Build headers
	headers := make(http.Header)
	headers.Set("Authorization", req.Auth)

	// Build body
	var bodyReader io.Reader

	// Execute request
	doErr := c.do(ctx, "GET", path, query, headers, bodyReader, &out)
	return out, doErr
}

// CreatePet calls POST /pets
func (c *Client) CreatePet(ctx context.Context, req exampleapi.CreatePetReq) (exampleapi.CreatePetResp, error) {
	var out exampleapi.CreatePetResp

	// Build path
	path := "/pets"

	// Build query
	query := url.Values{}

	// Build headers
	headers := make(http.Header)

	// Build body
	bodyReader, encErr := portapi.EncodeJSON(req)
	if encErr != nil {
		return out, encErr
	}

	// Execute request
	doErr := c.do(ctx, "POST", path, query, headers, bodyReader, &out)
	return out, doErr
}

// UpdatePet calls PUT /pets/{id}
func (c *Client) UpdatePet(ctx context.Context, req exampleapi.UpdatePetReq) (exampleapi.UpdatePetResp, error) {
	var out exampleapi.UpdatePetResp

	// Build path
	pathVars := map[string]string{
		"id": req.ID,
	}
	path, pathErr := portapi.InterpolatePath("/pets/{id}", pathVars)
	if pathErr != nil {
		return out, pathErr
	}

	// Build query
	query := url.Values{}

	// Build headers
	headers := make(http.Header)

	// Build body
	bodyReader, encErr := portapi.EncodeJSON(req)
	if encErr != nil {
		return out, encErr
	}

	// Execute request
	doErr := c.do(ctx, "PUT", path, query, headers, bodyReader, &out)
	return out, doErr
}
