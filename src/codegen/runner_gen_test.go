package codegen

import (
	"strings"
	"testing"
)

func TestGenerateRunner(t *testing.T) {
	code, err := GenerateRunner("migrations")
	if err != nil {
		t.Fatalf("GenerateRunner failed: %v", err)
	}

	codeStr := string(code)

	// Check for expected content
	expectations := []string{
		"package migrations",
		"Code generated by portsql",
		"DO NOT EDIT",
		"//go:embed schema.json",
		"var schemaJSON []byte",
		"func Plan()",
		"*migrate.MigrationPlan",
		"func Run(ctx context.Context, db *sql.DB, dialect string) error",
		"migrate.PlanFromJSON",
		"migrate.Run",
	}

	for _, expected := range expectations {
		if !strings.Contains(codeStr, expected) {
			t.Errorf("generated code should contain %q", expected)
		}
	}
}

func TestGenerateRunnerDifferentPackage(t *testing.T) {
	code, err := GenerateRunner("db")
	if err != nil {
		t.Fatalf("GenerateRunner failed: %v", err)
	}

	codeStr := string(code)
	if !strings.Contains(codeStr, "package db") {
		t.Error("generated code should have correct package name")
	}
}
