package codegen

import (
	"bytes"
	"go/format"
)

// GenerateRunner generates the runner.go file content.
// This file embeds schema.json and provides a Run() function for runtime migration.
func GenerateRunner(packageName string) ([]byte, error) {
	var buf bytes.Buffer

	buf.WriteString(`// Code generated by portsql. DO NOT EDIT.
package `)
	buf.WriteString(packageName)
	buf.WriteString(`

import (
	"context"
	"database/sql"
	_ "embed"

	"github.com/shipq/shipq/db/portsql/migrate"
)

//go:embed schema.json
var schemaJSON []byte

// Plan returns the migration plan reconstructed from the embedded schema.
func Plan() (*migrate.MigrationPlan, error) {
	return migrate.PlanFromJSON(schemaJSON)
}

// Run executes all pending migrations. Safe to call on every app startup.
// The dialect is auto-detected from the database connection.
func Run(ctx context.Context, db *sql.DB, dialect string) error {
	plan, err := Plan()
	if err != nil {
		return err
	}
	return migrate.Run(ctx, db, plan, dialect)
}
`)

	// Format the code
	formatted, err := format.Source(buf.Bytes())
	if err != nil {
		return buf.Bytes(), err
	}

	return formatted, nil
}
